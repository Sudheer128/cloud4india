version: '3.8'

services:
  cloud4india-web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL}
        - VITE_CMS_URL=${VITE_CMS_URL}
        - VITE_BASE_URL=${VITE_BASE_URL}
        - VITE_AI_API_KEY=${VITE_AI_API_KEY}
        - VITE_CLOUD4INDIA_API_URL=${VITE_CLOUD4INDIA_API_URL}
        - VITE_CLOUD4INDIA_API_KEY=${VITE_CLOUD4INDIA_API_KEY}
        - VITE_PORTAL_URL=${VITE_PORTAL_URL}
        - VITE_DOCS_URL=${VITE_DOCS_URL}
        - VITE_MAIN_SITE_URL=${VITE_MAIN_SITE_URL}
    container_name: cloud4india-website
    ports:
      - "4001:80"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
    depends_on:
      - cloud4india-cms
    networks:
      - cloud4india-network

  cloud4india-cms:
    build:
      context: ./cloud4india-cms
      dockerfile: Dockerfile
    container_name: cloud4india-cms
    ports:
      - "4002:3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
      - CLOUD4INDIA_API_URL=${VITE_CLOUD4INDIA_API_URL}
      - CLOUD4INDIA_API_KEY=${VITE_CLOUD4INDIA_API_KEY}
      - CLOUD4INDIA_SYNC_INTERVAL=15
    volumes:
      - ./cloud4india-cms/cms.db:/app/cms.db
      - ./cloud4india-cms-uploads:/app/uploads
    networks:
      - cloud4india-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  db-admin:
    image: adminer:latest
    container_name: cloud4india-db-admin
    ports:
      - "4003:8080"
    restart: unless-stopped
    environment:
      - ADMINER_DEFAULT_SERVER=sqlite
      - ADMINER_DESIGN=pepa-linha
    volumes:
      - ./cloud4india-cms-data:/var/lib/sqlite
    networks:
      - cloud4india-network
    depends_on:
      - cloud4india-cms

networks:
  cloud4india-network:
    driver: bridge
